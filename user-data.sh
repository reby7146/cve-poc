#!/bin/bash

yum update -y
yum install -y gcc make gcc-c++ pcre-devel openssl11 expat-devel

mkdir /home/ec2-user/tmp
cd /home/ec2-user/tmp
wget https://archive.apache.org/dist/httpd/httpd-2.4.48.tar.gz
wget https://dlcdn.apache.org//apr/apr-1.7.0.tar.gz
wget https://dlcdn.apache.org//apr/apr-util-1.6.1.tar.gz
wget https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.40/pcre2-10.40.tar.gz

mv apr-1.7.0.tar.gz apr-util-1.6.1.tar.gz httpd-2.4.48.tar.gz pcre2-10.40.tar.gz /usr/local/src
cd /usr/local/src
tar xvzf apr-1.7.0.tar.gz
tar xvzf apr-util-1.6.1.tar.gz
tar xvzf httpd-2.4.48.tar.gz
tar xvzf pcre2-10.40.tar.gz

cd /usr/local/src/pcre2-10.40
/usr/local/src/pcre2-10.40/configure
make && make install

cd /usr/local/src/apr-1.7.0 --prefix=/usr/local/src/apr-1.7.9
/usr/local/src/apr-1.7.0/configure
make && make install

cd /usr/local/src/apr-util-1.6.1
/usr/local/src/apr-util-1.6.1/configure --with-apr=/usr/local/src/apr-1.7.0
make && make install

cd /usr/local/src/httpd-2.4.48
/usr/local/src/httpd-2.4.48/configure --prefix=/usr/local/apache2  --with-apr=/usr/local/src/apr-1.7.0 --with-apr-util=/usr/local/src/apr-util-1.6.1
make && make install

export AWS_DEFAULT_REGION=ap-northeast-2
AWSDNSNAME=$(aws elbv2 describe-load-balancers --names "was-alb" | grep -o -P '(?<=DNSName": ")\S+(?=")')
echo "

LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
<VirtualHost *:80>
    ServerName localhost
    Header Set Pragma \"no-cache\"
    Header Set Expires \"Thu, 1 Jan 1970 00:00:00 GMT\"
    Header Set Cache-Control \"max-age=0, no-store, no-cache, must-revalidata\"
    Header Unset ETag
    FileETag None
    ErrorLog /usr/local/apache2/logs/temp_error.log
    CustomLog /usr/local/apache2/logs/temp_access.log combined
    ProxyRequests Off
    ProxyPreserveHost On
    <Location /was>
        ProxyPass \"http://$AWSDNSNAME:80/\"
        ProxyPassReverse \"http://$AWSDNSNAME:80/\"
    </Location>
    <Location /admin>
        ProxyPass \"http://$AWSDNSNAME:80/\"
        ProxyPassReverse \"http://$AWSDNSNAME:80/\"
    </Location>
</VirtualHost>" >> /usr/local/apache2/conf/httpd.conf
hostname >> /usr/local/apache2/htdocs/index.html

/usr/local/apache2/bin/httpd -k start
